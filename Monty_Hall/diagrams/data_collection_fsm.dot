digraph DataCollectionFSM {
  graph [rankdir=LR, labelloc="t", fontsize=18,
         label="Monty Hall Data-Collection EFSM\n(what we do, what we log, and when we stop)",
         fontname="Helvetica", pad="0.25", nodesep="0.35", ranksep="0.45"];
  node  [shape=box, style="rounded", fontname="Helvetica", fontsize=11];
  edge  [fontname="Helvetica", fontsize=10];

  // --- Clusters to make it “pop” without becoming a rainbow disaster ---
  subgraph cluster_setup {
    label="Trial Setup";
    style="rounded";
    Start   [label="Start / Next Trial\n(action: trial_id += 1)"];
    Seed    [label="Seed RNG (optional)\n(action: set seed)"];
    Prize   [label="Place Prize\n(action: prize_door = rand{1,2,3}\nlog: prize_door)"];
  }

  subgraph cluster_play {
    label="Gameplay";
    style="rounded";
    Pick    [label="Player Chooses Door\n(action: player_door = rand{1,2,3}\nlog: player_door)"];
    Reveal  [label="Host Reveals Goat Door\n(action: reveal_door = legal goat door\nconstraint: reveal_door ≠ prize_door,\n            reveal_door ≠ player_door\nlog: reveal_door)"];
    Decide  [label="Player Decision\n(action: decision = coin_toss stay/switch\nlog: decision)"];
    Final   [label="Finalize Door\n(action: final_door = player_door if stay\n                 else remaining closed door\nlog: final_door)"];
    Resolve [label="Resolve Outcome\n(action: win = (final_door == prize_door)\nlog: win)"];
  }

  subgraph cluster_log {
    label="Logging + Aggregation";
    style="rounded";
    Row     [label="Write Trial Row (CSV)\n(trial_id, seed, prize_door,\n player_door, reveal_door,\n decision, final_door, win, strategy)"];
    Agg     [label="Update Counters\nstay_win/stay_lose\nswitch_win/switch_lose\n+ distributions for doors/decision"];
    CI      [label="Update Stopping Stats\n(action: compute p̂ and CI halfwidths\nfor stay and switch)"];
  }

  subgraph cluster_stop {
    label="Stop?";
    style="rounded";
    Check   [label="Stopping Rule\nIF halfwidth(stay)≤ε AND\n   halfwidth(switch)≤ε\nTHEN stop\nELSE continue"];
    Stop    [shape=doubleoctagon, style="rounded", label="Stop + Export Summary\n(action: finalize tables/plots)"];
  }

  // --- Transitions ---
  Start  -> Seed   [label="begin_trial"];
  Seed   -> Prize  [label="rng_ready"];
  Prize  -> Pick   [label="prize_set"];
  Pick   -> Reveal [label="player_picked"];
  Reveal -> Decide [label="goat_revealed"];
  Decide -> Final  [label="decision_made"];
  Final  -> Resolve[label="door_finalized"];
  Resolve-> Row    [label="outcome_known"];
  Row    -> Agg    [label="row_written"];
  Agg    -> CI     [label="counters_updated"];
  CI     -> Check  [label="stats_updated"];
  Check  -> Stop   [label="stop = true"];
  Check  -> Start  [label="stop = false"];
}

